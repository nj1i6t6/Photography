<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI 圖像辨識翻譯</title>
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --background-color: #f8f9fa;
            --text-color: #212529;
            --card-bg: #ffffff;
            --border-radius: 8px;
            --box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 15px;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
        }
        .container {
            width: 100%;
            max-width: 500px;
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 20px;
        }
        h1 {
            color: var(--primary-color);
            text-align: center;
            font-size: 1.8em;
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        input[type="text"],
        input[type="password"],
        select {
            width: calc(100% - 22px);
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: var(--border-radius);
            font-size: 1em;
        }
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 1em;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color 0.3s ease;
            width: 100%;
            box-sizing: border-box;
        }
        button:hover {
            background-color: #0056b3;
        }
        button.secondary {
            background-color: var(--secondary-color);
        }
        button.secondary:hover {
            background-color: #545b62;
        }
        button.tertiary {
            background-color: #28a745; 
        }
        button.tertiary:hover {
            background-color: #1e7e34;
        }

        #cameraView, #appView {
            width: 100%;
        }
        #videoPreview {
            width: 100%;
            max-width: 480px;
            height: auto;
            border: 1px solid #ccc;
            background-color: #000;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
        }
        #capturedImage {
            max-width: 100%;
            height: auto;
            border: 1px solid #ccc;
            border-radius: var(--border-radius);
            margin-top: 15px;
            display: none;
        }
        #resultArea, #moreInfoResultArea {
            margin-top: 15px;
            padding: 15px;
            background-color: #e9ecef;
            border-radius: var(--border-radius);
            min-height: 40px;
            white-space: pre-wrap; 
            word-wrap: break-word;
            font-size: 0.95em;
        }
        #moreInfoResultArea {
            background-color: #e0e0e0; 
        }
        .hidden {
            display: none !important;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .button-group button {
            flex: 1;
        }
        #moreInfoSection {
            margin-top: 15px;
            width: 100%;
        }
    </style>
</head>
<body>
    <div id="settingsView" class="container">
        <h1>設定</h1>
        <div>
            <label for="apiKey" data-i18n="apiKeyLabel">API 金鑰:</label>
            <input type="password" id="apiKey" placeholder="請輸入您的 Gemini API 金鑰">
        </div>
        <div>
            <label for="targetLanguage" data-i18n="languageLabel">目標語言:</label>
            <select id="targetLanguage">
                <option value="zh-TW">繁體中文 (台灣)</option>
                <option value="en">English</option>
                <option value="ja">日本語</option>
                <option value="ko">한국어</option>
            </select>
        </div>
        <button id="saveSettings" data-i18n="saveSettingsButton">儲存設定並開始</button>
    </div>

    <div id="appView" class="container hidden">
        <h1 data-i18n="appTitle">這是啥？AI幫你看</h1>
        <div id="cameraView">
            <video id="videoPreview" autoplay playsinline></video>
            <button id="captureButton" data-i18n="captureButton">拍攝</button>
            <canvas id="canvas" class="hidden"></canvas>
        </div>
        
        <img id="capturedImage" alt="Captured Image">
        
        <div id="controlsAfterCapture" class="hidden">
            <p id="promptHelper" data-i18n="promptHelperText">照片拍好囉！按「這是什麼？」讓 AI 幫你看。</p>
            <div class="button-group">
                <button id="describeButtonPrimary" data-i18n="describeButton">這是什麼？</button>
                <button id="recaptureButton" class="secondary" data-i18n="recaptureButton">重新拍攝</button>
            </div>
        </div>

        <div id="loadingIndicator" class="loader hidden"></div>
        <div id="resultArea" data-i18n-placeholder="resultPlaceholder">AI 的分析結果會顯示在這裡喔！</div>
        
        <div id="moreInfoSection" class="hidden">
            <button id="tellMeMoreButton" class="tertiary" data-i18n="tellMeMoreButton">想知道更多！</button>
            <div id="moreInfoLoadingIndicator" class="loader hidden"></div>
            <div id="moreInfoResultArea" data-i18n-placeholder="moreInfoPlaceholder">更多細節會在這裡出現...</div>
        </div>

        <button id="backToSettings" class="secondary" data-i18n="backToSettingsButton" style="margin-top: 20px;">返回設定</button>
    </div>

    <script>
        const settingsView = document.getElementById('settingsView');
        const appView = document.getElementById('appView');
        const apiKeyInput = document.getElementById('apiKey');
        const targetLanguageSelect = document.getElementById('targetLanguage');
        const saveSettingsButton = document.getElementById('saveSettings');
        
        const videoPreview = document.getElementById('videoPreview');
        const canvas = document.getElementById('canvas');
        const captureButton = document.getElementById('captureButton');
        const capturedImage = document.getElementById('capturedImage');
        const describeButtonPrimary = document.getElementById('describeButtonPrimary');
        const recaptureButton = document.getElementById('recaptureButton');
        const controlsAfterCapture = document.getElementById('controlsAfterCapture');
        
        const loadingIndicator = document.getElementById('loadingIndicator');
        const resultArea = document.getElementById('resultArea');
        const backToSettingsButton = document.getElementById('backToSettings');
        const promptHelper = document.getElementById('promptHelper');

        const moreInfoSection = document.getElementById('moreInfoSection');
        const tellMeMoreButton = document.getElementById('tellMeMoreButton');
        const moreInfoLoadingIndicator = document.getElementById('moreInfoLoadingIndicator');
        const moreInfoResultArea = document.getElementById('moreInfoResultArea');

        let stream;
        let currentApiKey = '';
        let currentTargetLanguage = 'zh-TW';
        let initialAIDescription = ''; 

        const i18n = {
            'zh-TW': {
                apiKeyLabel: 'API 金鑰:',
                languageLabel: '目標語言:',
                saveSettingsButton: '儲存設定並開始',
                appTitle: '這是啥？AI幫你看',
                captureButton: '拍攝',
                describeButton: '這是什麼？',
                recaptureButton: '重新拍攝',
                resultPlaceholder: 'AI 的分析結果會顯示在這裡喔！',
                backToSettingsButton: '返回設定',
                alert_apiKeyRequired: '請先輸入你的 API 金鑰啦！',
                alert_cameraError: '哎呀，相機打不開捏: ',
                alert_apiError: 'API 請求失敗：', // Modified for better concatenation
                alert_noImage: '要先拍張照片才能分析啦！',
                promptHelperText: '照片拍好囉！按「這是什麼？」讓 AI 幫你看。',
                apiPromptInitial: "這張照片裡是什麼？請你扮演一位很懂台灣用語的導遊，用台灣人一聽就懂的輕鬆口語（繁體中文），超簡潔地告訴我：1. 這個東西的「品名」(台灣人常怎麼稱呼它)。 2. 它最「主要的用途或特色」(挑一個最重要的講)。 3. 「價格」大概多少 (如果照片裡看得到的話)。請務必直接給我純文字答案，不要用任何項目符號、星號、井字號之類的markdown格式，一句話能講完重點最好，拜託了！",
                apiPromptDetailed: "針對你剛剛說的「{initialDescription}」，可以再多告訴我一些嗎？例如：在台灣，這個東西通常要怎麼用啊？有沒有什麼特別要注意的地方？或是在哪裡比較容易買到或體驗到？一樣用台灣人聽得懂的口語（繁體中文）解釋喔，請給我純文字，不要用 markdown 格式，謝謝！",
                apiResponsePrefix: 'AI 說：\n',
                tellMeMoreButton: '想知道更多！',
                moreInfoPlaceholder: '更多細節會在這裡出現...',
                moreInfoResponsePrefix: 'AI 補充說明：\n'
            },
            'en': { 
                apiKeyLabel: 'API Key:',
                languageLabel: 'Target Language:',
                saveSettingsButton: 'Save Settings & Start',
                appTitle: "What's This? AI Vision",
                captureButton: 'Capture',
                describeButton: "What's this?",
                recaptureButton: 'Recapture',
                resultPlaceholder: 'AI analysis will appear here!',
                backToSettingsButton: 'Back to Settings',
                alert_apiKeyRequired: 'Please enter your API Key.',
                alert_cameraError: 'Could not start camera: ',
                alert_apiError: 'API request failed: ', // Modified
                alert_noImage: 'Please capture an image first!',
                promptHelperText: 'Photo captured! Click "What\'s this?" for AI to analyze.',
                apiPromptInitial: "What's in this picture? Act as a tour guide familiar with common English. Briefly tell me: 1. Its 'name' (common term). 2. Its 'main purpose or feature' (most important). 3. 'Price' (if visible). Please provide a plain text answer, no markdown (like bullets or asterisks). One sentence is best. Thanks!",
                apiPromptDetailed: "Regarding the '{initialDescription}' you just mentioned, can you tell me more? For example: How is it typically used? Any special precautions? Where can I find/experience it? Explain in simple English, plain text only, no markdown. Thanks!",
                apiResponsePrefix: 'AI says:\n',
                tellMeMoreButton: 'Tell me more!',
                moreInfoPlaceholder: 'More details will appear here...',
                moreInfoResponsePrefix: 'AI adds:\n'
            },
        };

        function cleanApiResponse(text) {
            if (!text) return '';
            let cleanedText = text.replace(/^[*\-]\s+/gm, ''); 
            cleanedText = cleanedText.replace(/(\*\*|__)(.*?)\1/g, '$2'); 
            cleanedText = cleanedText.replace(/(\*|_)(.*?)\1/g, '$2');  
            return cleanedText.trim();
        }
        
        function updateUIStrings(lang) {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (i18n[lang] && i18n[lang][key]) {
                    el.textContent = i18n[lang][key];
                }
            });
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (i18n[lang] && i18n[lang][key]) {
                    if (el.id === 'resultArea' && (el.textContent.trim() === '' || Object.values(i18n).some(val => val.resultPlaceholder === el.textContent.trim()))) {
                       el.textContent = i18n[lang][key];
                    } else if (el.id === 'moreInfoResultArea' && (el.textContent.trim() === '' || Object.values(i18n).some(val => val.moreInfoPlaceholder === el.textContent.trim()))) {
                       el.textContent = i18n[lang][key];
                    } else if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                       el.placeholder = i18n[lang][key];
                    }
                }
            });
            currentTargetLanguage = lang;
            localStorage.setItem('targetLanguage', lang);
            if (!controlsAfterCapture.classList.contains('hidden')) {
                promptHelper.textContent = i18n[currentTargetLanguage].promptHelperText;
            }
            const mainTitle = document.querySelector('h1[data-i18n="appTitle"]');
            if (mainTitle && i18n[lang] && i18n[lang].appTitle) {
                mainTitle.textContent = i18n[lang].appTitle;
            }
            const describeBtn = document.getElementById('describeButtonPrimary');
            if (describeBtn && i18n[lang] && i18n[lang].describeButton) {
                describeBtn.textContent = i18n[lang].describeButton;
            }
            const tellMoreBtn = document.getElementById('tellMeMoreButton');
             if (tellMoreBtn && i18n[lang] && i18n[lang].tellMeMoreButton) {
                tellMoreBtn.textContent = i18n[lang].tellMeMoreButton;
            }
        }
        
        function loadSettings() {
            const savedApiKey = localStorage.getItem('apiKey');
            const savedLanguage = localStorage.getItem('targetLanguage');

            if (savedApiKey) {
                apiKeyInput.value = savedApiKey;
                currentApiKey = savedApiKey;
            }
            if (savedLanguage && i18n[savedLanguage]) {
                targetLanguageSelect.value = savedLanguage;
                currentTargetLanguage = savedLanguage;
            } else {
                targetLanguageSelect.value = 'zh-TW'; 
                currentTargetLanguage = 'zh-TW';
            }
            updateUIStrings(currentTargetLanguage);
        }

        async function startCamera() {
            try {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                videoPreview.srcObject = stream;
                videoPreview.classList.remove('hidden');
                captureButton.classList.remove('hidden');
                capturedImage.classList.add('hidden');
                controlsAfterCapture.classList.add('hidden');
                resultArea.textContent = i18n[currentTargetLanguage].resultPlaceholder;
                moreInfoSection.classList.add('hidden');
                moreInfoResultArea.textContent = i18n[currentTargetLanguage].moreInfoPlaceholder;
                initialAIDescription = '';
            } catch (err) {
                console.error("Error accessing camera: ", err);
                resultArea.textContent = i18n[currentTargetLanguage].alert_cameraError + err.message;
            }
        }

        saveSettingsButton.addEventListener('click', () => {
            const apiKey = apiKeyInput.value.trim();
            if (!apiKey) {
                alert(i18n[currentTargetLanguage].alert_apiKeyRequired);
                return;
            }
            currentApiKey = apiKey;
            localStorage.setItem('apiKey', apiKey);
            
            currentTargetLanguage = targetLanguageSelect.value;
            localStorage.setItem('targetLanguage', currentTargetLanguage);
            updateUIStrings(currentTargetLanguage); 

            settingsView.classList.add('hidden');
            appView.classList.remove('hidden');
            startCamera();
        });

        targetLanguageSelect.addEventListener('change', (event) => {
            if (i18n[event.target.value]) {
                updateUIStrings(event.target.value);
            }
        });

        captureButton.addEventListener('click', () => {
            canvas.width = videoPreview.videoWidth;
            canvas.height = videoPreview.videoHeight;
            const context = canvas.getContext('2d');
            context.drawImage(videoPreview, 0, 0, canvas.width, canvas.height);
            
            const imageDataUrl = canvas.toDataURL('image/jpeg', 0.85); 
            capturedImage.src = imageDataUrl;
            capturedImage.classList.remove('hidden');
            
            videoPreview.classList.add('hidden');
            captureButton.classList.add('hidden');
            controlsAfterCapture.classList.remove('hidden');
            promptHelper.textContent = i18n[currentTargetLanguage].promptHelperText;
            moreInfoSection.classList.add('hidden'); 
            resultArea.textContent = i18n[currentTargetLanguage].resultPlaceholder; 
            initialAIDescription = '';

            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        });

        recaptureButton.addEventListener('click', () => {
            startCamera(); 
        });

        async function callGeminiAPI(prompt, loadingElement, resultDisplayElement, resultPrefix, generationConf = {}) {
            if (!capturedImage.src || capturedImage.src === window.location.href || capturedImage.src.startsWith('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=')) { 
                alert(i18n[currentTargetLanguage].alert_noImage);
                return null;
            }
            if (!currentApiKey) {
                alert(i18n[currentTargetLanguage].alert_apiKeyRequired);
                return null;
            }

            loadingElement.classList.remove('hidden');
            resultDisplayElement.textContent = ''; 

            const base64ImageData = capturedImage.src.split(',')[1];
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${currentApiKey}`;
            
            const requestBody = {
                contents: [{
                    parts: [
                        { text: prompt },
                        {
                            inline_data: {
                                mime_type: "image/jpeg",
                                data: base64ImageData
                            }
                        }
                    ]
                }],
                 generationConfig: { 
                   temperature: 0.2, 
                   maxOutputTokens: prompt === i18n[currentTargetLanguage].apiPromptInitial ? 256 : 1024, 
                   ...generationConf 
                 }
            };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                const responseText = await response.text();

                if (!response.ok) {
                    console.error('API Request Failed. Status:', response.status, 'Response Body:', responseText);
                    let errorMessage = `HTTP ${response.status}. `;
                    try {
                        const errorJson = JSON.parse(responseText);
                        if (errorJson.error && errorJson.error.message) {
                            errorMessage += errorJson.error.message;
                        } else {
                             errorMessage += "Could not parse error message from response. Check console.";
                        }
                    } catch (e) {
                        errorMessage += `Non-JSON error response. Check console. (First 100 chars: ${responseText.substring(0,100)})`;
                    }
                    resultDisplayElement.textContent = i18n[currentTargetLanguage].alert_apiError + errorMessage;
                    return null;
                }

                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (e) {
                    console.error("Failed to parse API success response as JSON:", responseText, e);
                    resultDisplayElement.textContent = i18n[currentTargetLanguage].alert_apiError + 'API response was successful but not valid JSON. Check console.';
                    return null;
                }

                console.log("Raw API Response (Success):", JSON.stringify(data, null, 2)); // Crucial log
                
                if (data.candidates && data.candidates.length > 0 && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts.length > 0 && data.candidates[0].content.parts[0].text) {
                    const rawDescription = data.candidates[0].content.parts[0].text;
                    const cleanedDescription = cleanApiResponse(rawDescription);
                    resultDisplayElement.textContent = resultPrefix + cleanedDescription;
                    return cleanedDescription;
                } else if (data.candidates && data.candidates.length > 0 && data.candidates[0].finishReason && data.candidates[0].finishReason !== "STOP") {
                    console.warn("API call finished with reason:", data.candidates[0].finishReason, "Safety Ratings:", data.candidates[0].safetyRatings);
                    let finishMessage = `${i18n[currentTargetLanguage].alert_apiError} Request finished with reason: ${data.candidates[0].finishReason}.`;
                    if (data.candidates[0].safetyRatings) {
                        finishMessage += ` Safety Ratings: ${data.candidates[0].safetyRatings.map(r => `${r.category}: ${r.probability}`).join(', ')}`;
                    }
                    resultDisplayElement.textContent = finishMessage;
                } else if (data.promptFeedback?.blockReason) {
                    let blockMessage = `${i18n[currentTargetLanguage].alert_apiError} Blocked by API. Reason: ${data.promptFeedback.blockReason}`;
                     if (data.promptFeedback.safetyRatings) {
                        blockMessage += `\nDetails: ${data.promptFeedback.safetyRatings.map(r => `${r.category}: ${r.probability}`).join(', ')}`;
                    }
                    resultDisplayElement.textContent = blockMessage;
                } else {
                    console.warn("Unexpected API response structure (no usable content or known error):", data);
                    resultDisplayElement.textContent = i18n[currentTargetLanguage].alert_apiError + 'Could not parse useful content from API response. Check console for raw response.';
                }
            } catch (error) {
                console.error("Error calling Gemini API (network or other script error):", error);
                resultDisplayElement.textContent = i18n[currentTargetLanguage].alert_apiError + error.message;
            } finally {
                loadingElement.classList.add('hidden');
            }
            return null;
        }

        describeButtonPrimary.addEventListener('click', async () => {
            moreInfoSection.classList.add('hidden'); 
            moreInfoResultArea.textContent = i18n[currentTargetLanguage].moreInfoPlaceholder; 

            const description = await callGeminiAPI(
                i18n[currentTargetLanguage].apiPromptInitial, 
                loadingIndicator, 
                resultArea, 
                i18n[currentTargetLanguage].apiResponsePrefix
            );
            if (description) {
                initialAIDescription = description; 
                moreInfoSection.classList.remove('hidden');
                tellMeMoreButton.classList.remove('hidden'); 
                moreInfoLoadingIndicator.classList.add('hidden'); 
            }
        });

        tellMeMoreButton.addEventListener('click', async () => {
            if (!initialAIDescription) {
                console.warn("No initial description available for 'tell me more'.");
                moreInfoResultArea.textContent = "請先取得初步描述。";
                return;
            }
            tellMeMoreButton.classList.add('hidden'); 

            let detailedPrompt = i18n[currentTargetLanguage].apiPromptDetailed.replace('{initialDescription}', initialAIDescription);
            
            await callGeminiAPI(
                detailedPrompt, 
                moreInfoLoadingIndicator, 
                moreInfoResultArea, 
                i18n[currentTargetLanguage].moreInfoResponsePrefix,
                { temperature: 0.3, maxOutputTokens: 1024 } 
            );
        });

        backToSettingsButton.addEventListener('click', () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            appView.classList.add('hidden');
            settingsView.classList.remove('hidden');
            capturedImage.src = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII="; 
            capturedImage.classList.add('hidden');
            resultArea.textContent = i18n[currentTargetLanguage].resultPlaceholder; 
            controlsAfterCapture.classList.add('hidden');
            moreInfoSection.classList.add('hidden');
            moreInfoResultArea.textContent = i18n[currentTargetLanguage].moreInfoPlaceholder;
            initialAIDescription = '';
            videoPreview.classList.remove('hidden'); 
            captureButton.classList.remove('hidden'); 
        });

        loadSettings();
        if (!currentApiKey) {
            settingsView.classList.remove('hidden');
            appView.classList.add('hidden');
        }
    </script>
</body>
</html>
