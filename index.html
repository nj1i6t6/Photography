<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI 圖像辨識翻譯</title>
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --background-color: #f8f9fa;
            --text-color: #212529;
            --card-bg: #ffffff;
            --border-radius: 8px;
            --box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 15px;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
        }
        .container {
            width: 100%;
            max-width: 500px;
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 20px;
        }
        h1 {
            color: var(--primary-color);
            text-align: center;
            font-size: 1.8em;
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        input[type="text"],
        input[type="password"],
        select {
            width: calc(100% - 22px);
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: var(--border-radius);
            font-size: 1em;
        }
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 1em;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color 0.3s ease;
            width: 100%;
            box-sizing: border-box;
        }
        button:hover {
            background-color: #0056b3;
        }
        button.secondary {
            background-color: var(--secondary-color);
        }
        button.secondary:hover {
            background-color: #545b62;
        }
        #cameraView, #appView {
            width: 100%;
        }
        #videoPreview {
            width: 100%;
            max-width: 480px;
            height: auto;
            border: 1px solid #ccc;
            background-color: #000;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
        }
        #capturedImage {
            max-width: 100%;
            height: auto;
            border: 1px solid #ccc;
            border-radius: var(--border-radius);
            margin-top: 15px;
            display: none;
        }
        #resultArea {
            margin-top: 20px;
            padding: 15px;
            background-color: #e9ecef;
            border-radius: var(--border-radius);
            min-height: 50px;
            white-space: pre-wrap; /* Preserve line breaks */
            word-wrap: break-word;
            font-size: 0.95em; /* Slightly smaller font for potentially longer text */
        }
        .hidden {
            display: none !important;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .button-group button {
            flex: 1;
        }
    </style>
</head>
<body>
    <div id="settingsView" class="container">
        <h1>設定</h1>
        <div>
            <label for="apiKey" data-i18n="apiKeyLabel">API 金鑰:</label>
            <input type="password" id="apiKey" placeholder="請輸入您的 Gemini API 金鑰">
        </div>
        <div>
            <label for="targetLanguage" data-i18n="languageLabel">目標語言:</label>
            <select id="targetLanguage">
                <option value="zh-TW">繁體中文 (台灣)</option>
                <option value="en">English</option>
                <option value="ja">日本語</option>
                <option value="ko">한국어</option>
                <!-- Add more languages if needed -->
            </select>
        </div>
        <button id="saveSettings" data-i18n="saveSettingsButton">儲存設定並開始</button>
    </div>

    <div id="appView" class="container hidden">
        <h1 data-i18n="appTitle">圖像辨識</h1>
        <div id="cameraView">
            <video id="videoPreview" autoplay playsinline></video>
            <button id="captureButton" data-i18n="captureButton">拍攝</button>
            <canvas id="canvas" class="hidden"></canvas>
        </div>
        
        <img id="capturedImage" alt="Captured Image">
        
        <div id="controlsAfterCapture" class="hidden">
            <p id="promptHelper" data-i18n="promptHelperText">已拍攝照片。點擊下方按鈕進行描述。</p>
            <div class="button-group">
                <button id="describeButton" data-i18n="describeButton">這是什麼？</button> <!-- Changed button text -->
                <button id="recaptureButton" class="secondary" data-i18n="recaptureButton">重新拍攝</button>
            </div>
        </div>

        <div id="loadingIndicator" class="loader hidden"></div>
        <div id="resultArea" data-i18n-placeholder="resultPlaceholder">辨識結果將顯示於此</div>
        <button id="backToSettings" class="secondary" data-i18n="backToSettingsButton" style="margin-top: 20px;">返回設定</button>
    </div>

    <script>
        const settingsView = document.getElementById('settingsView');
        const appView = document.getElementById('appView');
        const apiKeyInput = document.getElementById('apiKey');
        const targetLanguageSelect = document.getElementById('targetLanguage');
        const saveSettingsButton = document.getElementById('saveSettings');
        
        const videoPreview = document.getElementById('videoPreview');
        const canvas = document.getElementById('canvas');
        const captureButton = document.getElementById('captureButton');
        const capturedImage = document.getElementById('capturedImage');
        const describeButton = document.getElementById('describeButton');
        const recaptureButton = document.getElementById('recaptureButton');
        const controlsAfterCapture = document.getElementById('controlsAfterCapture');
        
        const loadingIndicator = document.getElementById('loadingIndicator');
        const resultArea = document.getElementById('resultArea');
        const backToSettingsButton = document.getElementById('backToSettings');
        const promptHelper = document.getElementById('promptHelper');

        let stream;
        let currentApiKey = '';
        let currentTargetLanguage = 'zh-TW';

        // --- MODIFIED I18N STRINGS ---
        const i18n = {
            'zh-TW': {
                apiKeyLabel: 'API 金鑰:',
                languageLabel: '目標語言:',
                saveSettingsButton: '儲存設定並開始',
                appTitle: '這是啥？AI幫你看', // Changed title
                captureButton: '拍攝',
                describeButton: '這是什麼？', // Changed button text
                recaptureButton: '重新拍攝',
                resultPlaceholder: 'AI 的分析結果會顯示在這裡喔！',
                backToSettingsButton: '返回設定',
                alert_apiKeyRequired: '請先輸入你的 API 金鑰啦！',
                alert_cameraError: '哎呀，相機打不開捏: ',
                alert_apiError: 'API 請求失敗，再試一次看看？ ',
                alert_noImage: '要先拍張照片才能分析啦！',
                promptHelperText: '照片拍好囉！按「這是什麼？」讓 AI 幫你看。',
                apiPrompt: "這張照片裡是什麼東西？請你用輕鬆、口語化的台灣用語（繁體中文）簡單說明一下它的「品名」和「主要用途或特色」。如果照片裡有價格、品牌或其他重要文字，也請一併告訴我。重點是讓我快速看懂，不用太學術或太詳細，謝謝！",
                apiResponsePrefix: 'AI 說：\n'
            },
            'en': {
                apiKeyLabel: 'API Key:',
                languageLabel: 'Target Language:',
                saveSettingsButton: 'Save Settings & Start',
                appTitle: "What's This? AI Vision", // Changed title
                captureButton: 'Capture',
                describeButton: "What's this?", // Changed button text
                recaptureButton: 'Recapture',
                resultPlaceholder: 'AI analysis will appear here!',
                backToSettingsButton: 'Back to Settings',
                alert_apiKeyRequired: 'Please enter your API Key.',
                alert_cameraError: 'Could not start camera: ',
                alert_apiError: 'API request failed. Try again? ',
                alert_noImage: 'Please capture an image first!',
                promptHelperText: 'Photo captured! Click "What\'s this?" for AI to analyze.',
                apiPrompt: "What's in this picture? Please briefly explain its 'name' and 'main purpose or features' in simple, clear English. If there's any price, brand, or other important text, please mention that too. The goal is quick understanding, so keep it concise, not too academic or detailed. Thanks!",
                apiResponsePrefix: 'AI says:\n'
            },
            'ja': {
                apiKeyLabel: 'APIキー:',
                languageLabel: 'ターゲット言語:',
                saveSettingsButton: '設定を保存して開始',
                appTitle: 'これは何？AI画像認識', // Changed title
                captureButton: '撮影',
                describeButton: 'これは何？', // Changed button text
                recaptureButton: '再撮影',
                resultPlaceholder: 'AIの解析結果はここに表示されます！',
                backToSettingsButton: '設定に戻る',
                alert_apiKeyRequired: 'APIキーを入力してください。',
                alert_cameraError: 'カメラを起動できませんでした: ',
                alert_apiError: 'APIリクエストに失敗しました。もう一度試しますか？',
                alert_noImage: 'まず画像を撮影してください！',
                promptHelperText: '写真が撮影されました。「これは何？」をクリックしてAIに解析させてください。',
                apiPrompt: "この写真には何が写っていますか？その「品名」と「主な用途や特徴」を、分かりやすく口語的な日本語で簡単に説明してください。もし価格、ブランド、その他の重要な文字があれば、それも教えてください。学術的すぎたり詳しすぎたりせず、すぐに理解できるように簡潔にお願いします。ありがとう！",
                apiResponsePrefix: 'AIの解析：\n'
            },
            'ko': {
                apiKeyLabel: 'API 키:',
                languageLabel: '대상 언어:',
                saveSettingsButton: '설정 저장 및 시작',
                appTitle: '이게 뭐지? AI 이미지 분석', // Changed title
                captureButton: '촬영',
                describeButton: '이게 뭐예요?', // Changed button text
                recaptureButton: '다시 촬영',
                resultPlaceholder: 'AI 분석 결과가 여기에 표시됩니다!',
                backToSettingsButton: '설정으로 돌아가기',
                alert_apiKeyRequired: 'API 키를 입력해주세요.',
                alert_cameraError: '카메라를 시작할 수 없습니다: ',
                alert_apiError: 'API 요청에 실패했습니다. 다시 시도하시겠습니까? ',
                alert_noImage: '먼저 이미지를 촬영해주세요!',
                promptHelperText: '사진이 촬영되었습니다! AI 분석을 위해 "이게 뭐예요?"를 클릭하세요.',
                apiPrompt: "이 사진에 무엇이 있나요? '제품명'과 '주요 용도 또는 특징'을 이해하기 쉽고 일상적인 한국어로 간략하게 설명해주세요. 가격, 브랜드 또는 기타 중요한 텍스트가 있다면 그것도 알려주세요. 학문적이거나 너무 상세하지 않고 빠르게 이해할 수 있도록 간결하게 부탁드립니다. 감사합니다!",
                apiResponsePrefix: 'AI 설명：\n'
            }
        };
        // --- END OF MODIFIED I18N STRINGS ---


        function updateUIStrings(lang) {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (i18n[lang] && i18n[lang][key]) {
                    el.textContent = i18n[lang][key];
                }
            });
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (i18n[lang] && i18n[lang][key]) {
                    if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                        el.placeholder = i18n[lang][key];
                    } else {
                        if (el.id === 'resultArea' && (el.textContent.trim() === '' || el.textContent.startsWith('辨識結果將顯示於此') || el.textContent.startsWith('Recognition result will appear here') || el.textContent.startsWith('AI の分析結果会显示在这里喔！') || el.textContent.startsWith('AI 분석 결과가 여기에 표시됩니다!'))) {
                           el.textContent = i18n[lang][key];
                        }
                    }
                }
            });
            currentTargetLanguage = lang;
            localStorage.setItem('targetLanguage', lang);
            if (!controlsAfterCapture.classList.contains('hidden')) {
                promptHelper.textContent = i18n[currentTargetLanguage].promptHelperText;
            }
             // Update main title based on language
            const mainTitle = document.querySelector('h1[data-i18n="appTitle"]');
            if (mainTitle && i18n[lang] && i18n[lang].appTitle) {
                mainTitle.textContent = i18n[lang].appTitle;
            }
             // Update describe button text
            const describeBtn = document.getElementById('describeButton');
            if (describeBtn && i18n[lang] && i18n[lang].describeButton) {
                describeBtn.textContent = i18n[lang].describeButton;
            }
        }
        
        function loadSettings() {
            const savedApiKey = localStorage.getItem('apiKey');
            const savedLanguage = localStorage.getItem('targetLanguage');

            if (savedApiKey) {
                apiKeyInput.value = savedApiKey;
                currentApiKey = savedApiKey;
            }
            if (savedLanguage) {
                targetLanguageSelect.value = savedLanguage;
                currentTargetLanguage = savedLanguage;
            } else {
                targetLanguageSelect.value = 'zh-TW'; 
                currentTargetLanguage = 'zh-TW';
            }
            updateUIStrings(currentTargetLanguage);
        }

        async function startCamera() {
            try {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                videoPreview.srcObject = stream;
                videoPreview.classList.remove('hidden');
                captureButton.classList.remove('hidden');
                capturedImage.classList.add('hidden');
                controlsAfterCapture.classList.add('hidden');
                resultArea.textContent = i18n[currentTargetLanguage].resultPlaceholder;
            } catch (err) {
                console.error("Error accessing camera: ", err);
                resultArea.textContent = i18n[currentTargetLanguage].alert_cameraError + err.message;
            }
        }

        saveSettingsButton.addEventListener('click', () => {
            const apiKey = apiKeyInput.value.trim();
            if (!apiKey) {
                alert(i18n[currentTargetLanguage].alert_apiKeyRequired);
                return;
            }
            currentApiKey = apiKey;
            localStorage.setItem('apiKey', apiKey);
            
            currentTargetLanguage = targetLanguageSelect.value;
            localStorage.setItem('targetLanguage', currentTargetLanguage);
            updateUIStrings(currentTargetLanguage); 

            settingsView.classList.add('hidden');
            appView.classList.remove('hidden');
            startCamera();
        });

        targetLanguageSelect.addEventListener('change', (event) => {
            updateUIStrings(event.target.value);
        });

        captureButton.addEventListener('click', () => {
            canvas.width = videoPreview.videoWidth;
            canvas.height = videoPreview.videoHeight;
            const context = canvas.getContext('2d');
            context.drawImage(videoPreview, 0, 0, canvas.width, canvas.height);
            
            const imageDataUrl = canvas.toDataURL('image/jpeg', 0.9); // Use JPEG with quality for potentially smaller size
            capturedImage.src = imageDataUrl;
            capturedImage.classList.remove('hidden');
            
            videoPreview.classList.add('hidden');
            captureButton.classList.add('hidden');
            controlsAfterCapture.classList.remove('hidden');
            promptHelper.textContent = i18n[currentTargetLanguage].promptHelperText;

            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        });

        recaptureButton.addEventListener('click', () => {
            startCamera(); 
        });

        describeButton.addEventListener('click', async () => {
            if (!capturedImage.src || capturedImage.src === window.location.href || capturedImage.src.startsWith('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=')) { 
                alert(i18n[currentTargetLanguage].alert_noImage);
                return;
            }
            if (!currentApiKey) {
                alert(i18n[currentTargetLanguage].alert_apiKeyRequired);
                return;
            }

            loadingIndicator.classList.remove('hidden');
            resultArea.textContent = ''; 

            const base64ImageData = capturedImage.src.split(',')[1];
            
            // Using the user-specified model
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${currentApiKey}`;
            
            const requestBody = {
                contents: [{
                    parts: [
                        { text: i18n[currentTargetLanguage].apiPrompt },
                        {
                            inline_data: {
                                mime_type: "image/jpeg",
                                data: base64ImageData
                            }
                        }
                    ]
                }],
                 generationConfig: { // Added generationConfig for potentially better control
                   temperature: 0.3, // Lower temperature for more factual/less creative responses
                   // topK: 32,
                   // topP: 1,
                   maxOutputTokens: 1024, // Limit output tokens for brevity
                   // stopSequences: []
                 }
            };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('API Error Response:', errorData);
                    throw new Error(`HTTP error! status: ${response.status} - ${errorData.error?.message || 'Unknown error'}`);
                }

                const data = await response.json();
                
                if (data.candidates && data.candidates.length > 0 && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts.length > 0) {
                    const description = data.candidates[0].content.parts[0].text;
                    resultArea.textContent = i18n[currentTargetLanguage].apiResponsePrefix + description;
                } else if (data.promptFeedback && data.promptFeedback.blockReason) {
                    let blockMessage = `${i18n[currentTargetLanguage].alert_apiError} Blocked by API. Reason: ${data.promptFeedback.blockReason}`;
                     if (data.promptFeedback.safetyRatings) {
                        blockMessage += `\nDetails: ${data.promptFeedback.safetyRatings.map(r => `${r.category} was ${r.probability}`).join(', ')}`;
                    }
                    resultArea.textContent = blockMessage;
                }
                else {
                    console.warn("Unexpected API response structure:", data);
                    resultArea.textContent = i18n[currentTargetLanguage].alert_apiError + 'Could not parse description from API response. Check console for details.';
                }

            } catch (error) {
                console.error("Error calling Gemini API:", error);
                resultArea.textContent = i18n[currentTargetLanguage].alert_apiError + error.message;
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        });

        backToSettingsButton.addEventListener('click', () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            appView.classList.add('hidden');
            settingsView.classList.remove('hidden');
            capturedImage.src = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII="; // Clear to a transparent pixel
            capturedImage.classList.add('hidden');
            resultArea.textContent = i18n[currentTargetLanguage].resultPlaceholder; // Reset placeholder
            controlsAfterCapture.classList.add('hidden');
            videoPreview.classList.remove('hidden'); // Show video preview again
            captureButton.classList.remove('hidden'); // Show capture button again
        });

        // Initial load
        loadSettings();
        if (currentApiKey) {
            // Decide if you want to auto-start or always show settings first
            // settingsView.classList.add('hidden');
            // appView.classList.remove('hidden');
            // startCamera();
        } else {
            settingsView.classList.remove('hidden');
            appView.classList.add('hidden');
        }

    </script>
</body>
</html>
