<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI 圖像辨識翻譯</title>
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --background-color: #f8f9fa;
            --text-color: #212529;
            --card-bg: #ffffff;
            --border-radius: 8px;
            --box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 15px;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
        }
        .container {
            width: 100%;
            max-width: 500px;
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 20px;
        }
        h1 {
            color: var(--primary-color);
            text-align: center;
            font-size: 1.8em;
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        input[type="text"],
        input[type="password"],
        select {
            width: calc(100% - 22px);
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: var(--border-radius);
            font-size: 1em;
        }
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 1em;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color 0.3s ease;
            width: 100%;
            box-sizing: border-box;
            margin-top: 5px; /* Added some margin for buttons */
            margin-bottom: 5px; /* Added some margin for buttons */
        }
        button:hover {
            background-color: #0056b3;
        }
        button.secondary {
            background-color: var(--secondary-color);
        }
        button.secondary:hover {
            background-color: #545b62;
        }
        #cameraView, #appView {
            width: 100%;
        }
        #videoPreview {
            width: 100%;
            max-width: 480px;
            height: auto;
            border: 1px solid #ccc;
            background-color: #000;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
        }
        #capturedImage {
            max-width: 100%;
            height: auto;
            border: 1px solid #ccc;
            border-radius: var(--border-radius);
            margin-top: 15px;
            display: none;
        }
        .info-display-area { /* Consolidated style for resultArea and moreInfoArea */
            margin-top: 20px;
            padding: 15px;
            background-color: #e9ecef;
            border-radius: var(--border-radius);
            min-height: 50px;
            word-wrap: break-word;
            font-size: 0.95em;
        }
        /* Styles for Markdown elements within info-display-area */
        .info-display-area h1, 
        .info-display-area h2, 
        .info-display-area h3, 
        .info-display-area h4, 
        .info-display-area h5, 
        .info-display-area h6 {
            margin-top: 1em;
            margin-bottom: 0.5em;
            color: var(--primary-color); /* Headings can use primary color */
            font-weight: bold;
        }
        .info-display-area h1 { font-size: 1.5em; }
        .info-display-area h2 { font-size: 1.3em; }
        .info-display-area h3 { font-size: 1.2em; }
        .info-display-area p {
            margin-top: 0.5em;
            margin-bottom: 0.5em;
            line-height: 1.6;
        }
        .info-display-area ul, .info-display-area ol {
            margin-top: 0.5em;
            margin-bottom: 0.5em;
            padding-left: 20px;
        }
        .info-display-area li {
            margin-bottom: 0.3em;
        }
        .info-display-area hr {
            border: 0;
            height: 1px;
            background-color: #ccc;
            margin: 1em 0;
        }
        .info-display-area strong {
            font-weight: bold;
        }
        .info-display-area table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1em;
            margin-bottom: 1em;
        }
        .info-display-area th, .info-display-area td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .info-display-area th {
            background-color: #f2f2f2;
            font-weight: bold;
        }


        .hidden {
            display: none !important;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .button-group button {
            flex: 1;
            margin-top: 0; /* Reset margin for buttons in group */
            margin-bottom: 0; /* Reset margin for buttons in group */
        }
    </style>
</head>
<body>
    <div id="settingsView" class="container">
        <h1>設定</h1>
        <div>
            <label for="apiKey" data-i18n="apiKeyLabel">API 金鑰:</label>
            <input type="password" id="apiKey" placeholder="請輸入您的 Gemini API 金鑰">
        </div>
        <div>
            <label for="targetLanguage" data-i18n="languageLabel">目標語言:</label>
            <select id="targetLanguage">
                <option value="zh-TW">繁體中文 (台灣)</option>
                <option value="en">English</option>
                <option value="ja">日本語</option>
                <option value="ko">한국어</option>
                <!-- Add more languages if needed -->
            </select>
        </div>
        <button id="saveSettings" data-i18n="saveSettingsButton">儲存設定並開始</button>
    </div>

    <div id="appView" class="container hidden">
        <h1 data-i18n="appTitle">圖像辨識</h1>
        <div id="cameraView">
            <video id="videoPreview" autoplay playsinline></video>
            <button id="captureButton" data-i18n="captureButton">拍攝</button>
            <canvas id="canvas" class="hidden"></canvas>
        </div>
        
        <img id="capturedImage" alt="Captured Image">
        
        <div id="controlsAfterCapture" class="hidden">
            <p id="promptHelper" data-i18n="promptHelperText">已拍攝照片。點擊下方按鈕進行描述。</p>
            <div class="button-group">
                <button id="describeButton" data-i18n="describeButton">這是什麼？</button>
                <button id="recaptureButton" class="secondary" data-i18n="recaptureButton">重新拍攝</button>
            </div>
        </div>

        <div id="loadingIndicator" class="loader hidden"></div>
        <div id="resultArea" class="info-display-area" data-i18n-placeholder="resultPlaceholder">辨識結果將顯示於此</div>
        
        <button id="tellMeMoreButton" class="secondary hidden" data-i18n="tellMeMoreButtonLabel" style="margin-top: 15px;">告訴我更多</button>
        <div id="moreInfoLoadingIndicator" class="loader hidden"></div>
        <div id="moreInfoArea" class="info-display-area hidden" data-i18n-placeholder="moreInfoPlaceholder" style="margin-top:10px;">更多資訊將顯示於此</div>

        <button id="backToSettings" class="secondary" data-i18n="backToSettingsButton" style="margin-top: 20px;">返回設定</button>
    </div>

    <!-- Include Marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        const settingsView = document.getElementById('settingsView');
        const appView = document.getElementById('appView');
        const apiKeyInput = document.getElementById('apiKey');
        const targetLanguageSelect = document.getElementById('targetLanguage');
        const saveSettingsButton = document.getElementById('saveSettings');
        
        const videoPreview = document.getElementById('videoPreview');
        const canvas = document.getElementById('canvas');
        const captureButton = document.getElementById('captureButton');
        const capturedImage = document.getElementById('capturedImage');
        const describeButton = document.getElementById('describeButton');
        const recaptureButton = document.getElementById('recaptureButton');
        const controlsAfterCapture = document.getElementById('controlsAfterCapture');
        
        const loadingIndicator = document.getElementById('loadingIndicator');
        const resultArea = document.getElementById('resultArea');
        const backToSettingsButton = document.getElementById('backToSettings');
        const promptHelper = document.getElementById('promptHelper');

        // New elements for "Tell me more"
        const tellMeMoreButton = document.getElementById('tellMeMoreButton');
        const moreInfoLoadingIndicator = document.getElementById('moreInfoLoadingIndicator');
        const moreInfoArea = document.getElementById('moreInfoArea');

        let stream;
        let currentApiKey = '';
        let currentTargetLanguage = 'zh-TW';

        const i18n = {
            'zh-TW': {
                apiKeyLabel: 'API 金鑰:',
                languageLabel: '目標語言:',
                saveSettingsButton: '儲存設定並開始',
                appTitle: '這是啥？AI幫你看',
                captureButton: '拍攝',
                describeButton: '這是什麼？',
                recaptureButton: '重新拍攝',
                resultPlaceholder: 'AI 的分析結果會顯示在這裡喔！',
                backToSettingsButton: '返回設定',
                alert_apiKeyRequired: '請先輸入你的 API 金鑰啦！',
                alert_cameraError: '哎呀，相機打不開捏: ',
                alert_apiError: 'API 請求失敗，再試一次看看？ ',
                alert_noImage: '要先拍張照片才能分析啦！',
                promptHelperText: '照片拍好囉！按「這是什麼？」讓 AI 幫你看。',
                apiPrompt: `這張照片裡是什麼東西？請你嚴格依照以下「回覆樣板」的格式，並使用輕鬆、口語化的台灣用語（繁體中文）來回答。請根據圖片內容填寫 [方括號] 中的資訊。如果某項資訊在圖片中無法辨識，請在對應的 [方括號] 中填寫「看不太清楚耶」或「圖片裡沒有顯示喔」。如果沒有特別的品牌或型號資訊，該部分也填寫「看不太清楚耶」。

**如果圖片主要內容是菜單或價目表：**
請讓「品名」為「菜單」或「價目表」，「用途」為「提供餐點資訊與價格」，「價格」為「包含多項品項價格」。並且在「其他觀察到的資訊」中特別提醒：「這似乎是一份菜單喔！點擊『告訴我更多』可以查看詳細翻譯與價格對照。」

回覆樣板：
這叫做「[物品的台灣口語化通稱或品名]」。
用途（或主要成分，依圖片判斷）是「[描述用途/主要成分/特色]」。
價格「[如果圖片中有價格請提供，若無則填寫上述提示，例如：約 NT$XXX元 或 價格未顯示喔]」。

如果圖片中有清晰的品牌名稱、型號或其他重要文字，請在最後補充一行：「其他觀察到的資訊有：[品牌、型號等文字，若無則填寫 看不太清楚耶]」。
請確保回答自然流暢，謝謝！`,
                apiResponsePrefix: 'AI 說：\n',
                tellMeMoreButtonLabel: '告訴我更多關於它',
                apiPromptMoreInfo: `請詳細分析這張圖片的內容。

**如果這是一份菜單或價目表：**
請將其中所有清晰可見的品項，逐一列出原文、其在台灣口語化繁體中文的翻譯、以及對應的價格。請使用 Markdown 列表格式，確保清晰易讀。
**格式範例：**
- 原文: Fried Rice, 翻譯: 炒飯, 價格: NT$80
- 原文: Pork Noodles, 翻譯: 豬肉麵, 價格: NT$95
若價格不明顯，可寫「價格不明」。若某品項的原文或翻譯不明顯，也請誠實說明。

**如果這不是菜單，而是其他一般物品：**
請針對圖片中的主要物品，提供比之前初步描述更詳細的補充資訊。內容可以包含（但不限於）：使用教學、料理建議（如果適用）、保養存放（如果適用）、哪裡買/取得、相關提醒。

無論哪種情況，請用輕鬆口語、條理分明的台灣中文來介紹，讓內容更豐富實用。請使用 Markdown 格式（例如標題、列表、粗體）來讓內容更易讀，但不要使用太複雜的 Markdown 符號。`,
                moreInfoPlaceholder: '更多詳細資訊會顯示在這裡～',
                moreInfoPrefix: 'AI 補充說明：\n'
            },
            'en': {
                apiKeyLabel: 'API Key:',
                languageLabel: 'Target Language:',
                saveSettingsButton: 'Save Settings & Start',
                appTitle: "What's This? AI Vision",
                captureButton: 'Capture',
                describeButton: "What's this?",
                recaptureButton: 'Recapture',
                resultPlaceholder: 'AI analysis will appear here!',
                backToSettingsButton: 'Back to Settings',
                alert_apiKeyRequired: 'Please enter your API Key.',
                alert_cameraError: 'Could not start camera: ',
                alert_apiError: 'API request failed. Try again? ',
                alert_noImage: 'Please capture an image first!',
                promptHelperText: 'Photo captured! Click "What\'s this?" for AI to analyze.',
                apiPrompt: `What is in this picture? Please strictly follow the "Response Template" format below and use simple, clear English. Fill in the information in [square brackets] based on the image content. If some information cannot be identified from the image, please write "Not clear" or "Not shown in image" in the corresponding [bracket]. If no specific brand or model information is available, also write "Not clear".

**If the main content of the image is a menu or price list:**
Please set the "Name" to "Menu" or "Price List", "Purpose" to "Provides meal information and prices", and "Price" to "Contains prices for multiple items". Also, in "Other observed information", specifically prompt the user: "This seems to be a menu! Click 'Tell me more' to see detailed translations and prices."

Response Template:
This is called "[common name or product name]".
Its purpose (or main ingredients, judge by image) is "[describe purpose/main ingredients/features]".
The price is "[provide if price is visible in image, otherwise use above hints, e.g., approx. $XX or Price not shown]".

If there are clear brand names, model numbers, or other important text in the image, add a line at the end: "Other observed information: [brand, model, etc., if none then write Not clear]".
Please ensure the answer is natural and fluent. Thanks!`,
                apiResponsePrefix: 'AI says:\n',
                tellMeMoreButtonLabel: 'Tell me more about it',
                apiPromptMoreInfo: `Please analyze the content of this image in detail.

**If this is a menu or price list:**
Please list all clearly visible items, including their original text, their translation into simple, clear English, and their corresponding prices. Please use Markdown list format to ensure clarity and readability.
**Format example:**
- Original: Fried Rice, Translation: Fried Rice, Price: $80
- Original: Pork Noodles, Translation: Pork Noodles, Price: $95
If the price is unclear, write "Price unclear". If an item's original text or translation is unclear, please state it honestly.

**If this is not a menu, but another general item:**
Please provide more detailed supplementary information about the main item in the picture than the initial description. Content can include (but is not limited to): usage instructions, cooking suggestions (if applicable), maintenance/storage (if applicable), where to buy/get it, relevant reminders.

In either case, please use clear, well-organized English to introduce, making the content richer and more practical. Please use Markdown format (e.g., headings, lists, bold text) to make the content more readable, but avoid overly complex Markdown symbols.`,
                moreInfoPlaceholder: 'More detailed information will appear here!',
                moreInfoPrefix: 'AI adds:\n'
            },
            'ja': {
                apiKeyLabel: 'APIキー:',
                languageLabel: 'ターゲット言語:',
                saveSettingsButton: '設定を保存して開始',
                appTitle: 'これは何？AI画像認識',
                captureButton: '撮影',
                describeButton: 'これは何？',
                recaptureButton: '再撮影',
                resultPlaceholder: 'AIの解析結果はここに表示されます！',
                backToSettingsButton: '設定に戻る',
                alert_apiKeyRequired: 'APIキーを入力してください。',
                alert_cameraError: 'カメラを起動できませんでした: ',
                alert_apiError: 'APIリクエストに失敗しました。もう一度試しますか？',
                alert_noImage: 'まず画像を撮影してください！',
                promptHelperText: '写真が撮影されました。「これは何？」をクリックしてAIに解析させてください。',
                apiPrompt: `この写真には何が写っていますか？以下の「回答テンプレート」の形式に厳密に従い、わかりやすく口語的な日本語で回答してください。画像の内容に基づいて[角括弧]内の情報を記入してください。画像から情報が特定できない場合は、対応する[角括弧]に「不明瞭です」または「画像に表示されていません」と記入してください。特定のブランドやモデル情報がない場合も「不明瞭です」と記入してください。

**画像が主にメニューまたは価格表である場合：**
「品名」を「メニュー」または「価格表」、「用途」を「食事情報と価格の提供」、「価格」を「複数の品目の価格を含む」としてください。さらに、「その他観察された情報」で「これはメニューのようです！「もっと詳しく教えて」をクリックすると、詳細な翻訳と価格対照を確認できます。」とユーザーに明確に促してください。

回答テンプレート：
これは「[物品の一般的な呼称または品名]」と呼ばれます。
用途（または主な成分、画像から判断）は「[用途/主な成分/特徴を記述]」です。
価格は「[画像に価格が表示されていれば記入、なければ上記のヒントを使用。例：約XXX円または価格未表示です]」です。

画像に明確なブランド名、モデル番号、その他の重要なテキストがある場合は、最後に一行追加してください：「その他観察された情報：[ブランド、モデルなど、なければ不明瞭です]」。
回答は自然で流暢になるようお願いします。ありがとうございます！`,
                apiResponsePrefix: 'AIの解析：\n',
                tellMeMoreButtonLabel: 'もっと詳しく教えて',
                apiPromptMoreInfo: `この画像のコンテンツを詳細に分析してください。

**これがメニューまたは価格表である場合：**
画像に表示されているすべての項目について、原文、わかりやすい日本語での翻訳、および対応する価格を、Markdownのリスト形式で明確かつ読みやすくリストアップしてください。
**フォーマット例：**
- 原文: Fried Rice, 翻訳: チャーハン, 価格: 80円
- 原文: Pork Noodles, 翻訳: 豚肉麺, 価格: 95円
価格が不明な場合は「価格不明」と記述してください。品目の原文や翻訳が不明確な場合も正直に説明してください。

**これがメニューではなく、他の一般的なアイテムである場合：**
画像内の主要なアイテムについて、最初の説明よりも詳細な補足情報を提供してください。内容は以下を含むことができます（ただしこれらに限定されません）：使用方法、料理の提案（該当する場合）、メンテナンス/保管（該当する場合）、購入/入手場所、関連する注意点。

どちらの場合も、内容をより豊かで実用的なものにするため、わかりやすく整理された日本語で紹介してください。内容を読みやすくするためにMarkdown形式（例：見出し、リスト、太字）を使用してください。ただし、複雑すぎるMarkdown記号は避けてください。`,
                moreInfoPlaceholder: 'さらに詳しい情報はこちらに表示されます！',
                moreInfoPrefix: 'AIの補足説明：\n'
            },
            'ko': {
                apiKeyLabel: 'API 키:',
                languageLabel: '대상 언어:',
                saveSettingsButton: '설정 저장 및 시작',
                appTitle: '이게 뭐지? AI 이미지 분석',
                captureButton: '촬영',
                describeButton: '이게 뭐예요?',
                recaptureButton: '다시 촬영',
                resultPlaceholder: 'AI 분석 결과가 여기에 표시됩니다!',
                backToSettingsButton: '설정으로 돌아가기',
                alert_apiKeyRequired: 'API 키를 입력해주세요.',
                alert_cameraError: '카메라를 시작할 수 없습니다: ',
                alert_apiError: 'API 요청에 실패했습니다. 다시 시도하시겠습니까? ',
                alert_noImage: '먼저 이미지를 촬영해주세요!',
                promptHelperText: '사진이 촬영되었습니다! AI 분석을 위해 "이게 뭐예요?"를 클릭하세요.',
                apiPrompt: `이 사진에 무엇이 있습니까? 아래 "응답 템플릿" 형식을 엄격히 따르고 간단하고 명확한 한국어로 답변하십시오. 이미지 내용을 기반으로 [대괄호] 안의 정보를 입력하십시오. 이미지에서 일부 정보를 식별할 수 없는 경우 해당 [대괄호]에 "명확하지 않음" 또는 "이미지에 표시되지 않음"이라고 작성하십시오. 특정 브랜드나 모델 정보가 없는 경우에도 "명확하지 않음"이라고 작성하십시오.

**이미지의 주요 내용이 메뉴 또는 가격표인 경우:**
"품명"을 "메뉴" 또는 "가격표"로, "용도"를 "식사 정보 및 가격 제공"으로, "가격"을 "여러 항목의 가격 포함"으로 설정하십시오. 또한, "기타 관찰된 정보"에 "이것은 메뉴인 것 같습니다! '자세히 알려줘'를 클릭하면 자세한 번역 및 가격 대조를 볼 수 있습니다."라고 사용자에게 명확하게 안내하십시오.

응답 템플릿:
이것은 "[일반적인 이름 또는 제품 이름]"이라고 합니다.
용도(또는 주요 성분, 이미지로 판단)는 "[용도/주요 성분/특징 설명]"입니다.
가격은 "[이미지에 가격이 표시된 경우 제공, 그렇지 않은 경우 위 힌트 사용, 예: 약 XXX원 또는 가격이 표시되지 않음]"입니다.

이미지에 명확한 브랜드 이름, 모델 번호 또는 기타 중요한 텍스트가 있는 경우 마지막에 한 줄을 추가하십시오: "기타 관찰된 정보: [브랜드, 모델 등, 없는 경우 명확하지 않음]".
답변이 자연스럽고 유창하도록 해주십시오. 감사합니다!`,
                apiResponsePrefix: 'AI 설명：\n',
                tellMeMoreButtonLabel: '자세히 알려줘',
                apiPromptMoreInfo: `이 이미지의 내용을 자세히 분석하십시오.

**이것이 메뉴 또는 가격표인 경우:**
이미지에서 명확하게 보이는 모든 항목의 원문, 한국어로의 간결한 번역, 그리고 해당 가격을 목록 형식으로 명확하고 읽기 쉽게 나열하십시오.
**형식 예시:**
- 원문: Fried Rice, 번역: 볶음밥, 가격: 80원
- 원문: Pork Noodles, 번역: 돼지고기 국수, 가격: 95원
가격이 불분명한 경우 "가격 불분명"이라고 작성하십시오. 항목의 원문이나 번역이 불분명한 경우에도 솔직하게 설명하십시오.

**이것이 메뉴가 아닌 다른 일반적인 품목인 경우:**
사진 속 주요 품목에 대해 이전의 초기 설명보다 더 자세한 보충 정보를 제공하십시오. 내용은 다음을 포함할 수 있지만 이에 국한되지는 않습니다: 사용 지침, 요리 제안 (해당하는 경우), 유지 관리/보관 (해당하는 경우), 구입처/입수처, 관련 주의사항.

어떤 경우든, 내용을 더 풍부하고 실용적으로 만들기 위해 간결하고 체계적인 한국어로 소개하십시오. 내용을 더 쉽게 읽을 수 있도록 Markdown 형식(예: 제목, 목록, 굵은 텍스트)을 사용하십시오. 그러나 너무 복잡한 Markdown 기호는 피하십시오.`,
                moreInfoPlaceholder: '더 자세한 정보가 여기에 표시됩니다!',
                moreInfoPrefix: 'AI 추가 설명：\n'
            }
        };

        function updateUIStrings(lang) {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (i18n[lang] && i18n[lang][key]) {
                    el.textContent = i18n[lang][key];
                }
            });
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (i18n[lang] && i18n[lang][key]) {
                    if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                        el.placeholder = i18n[lang][key];
                    } else {
                        // Only update if it's the default placeholder or empty
                        const currentContent = el.textContent.trim();
                        // Check if current content matches any language's placeholder value (or is empty)
                        const placeholderValues = Object.values(i18n).map(translations => translations[key]).filter(Boolean);
                        if (el.textContent.trim() === '' || placeholderValues.some(pVal => currentContent.includes(pVal.substring(0, Math.min(currentContent.length, pVal.length))))) { // Match partial string for robustness
                           el.textContent = i18n[lang][key];
                        }
                    }
                }
            });
            currentTargetLanguage = lang;
            localStorage.setItem('targetLanguage', lang);
            if (!controlsAfterCapture.classList.contains('hidden')) {
                promptHelper.textContent = i18n[currentTargetLanguage].promptHelperText;
            }
            const mainTitle = document.querySelector('h1[data-i18n="appTitle"]');
            if (mainTitle && i18n[lang] && i18n[lang].appTitle) {
                mainTitle.textContent = i18n[lang].appTitle;
            }
            const describeBtn = document.getElementById('describeButton');
            if (describeBtn && i18n[lang] && i18n[lang].describeButton) {
                describeBtn.textContent = i18n[lang].describeButton;
            }
            // Update "Tell me more" button text
            if (tellMeMoreButton && i18n[lang] && i18n[lang].tellMeMoreButtonLabel) {
                tellMeMoreButton.textContent = i18n[lang].tellMeMoreButtonLabel;
            }
        }
        
        function loadSettings() {
            const savedApiKey = localStorage.getItem('apiKey');
            const savedLanguage = localStorage.getItem('targetLanguage');

            if (savedApiKey) {
                apiKeyInput.value = savedApiKey;
                currentApiKey = savedApiKey;
            }
            if (savedLanguage) {
                targetLanguageSelect.value = savedLanguage;
                currentTargetLanguage = savedLanguage;
            } else {
                targetLanguageSelect.value = 'zh-TW'; 
                currentTargetLanguage = 'zh-TW';
            }
            updateUIStrings(currentTargetLanguage);
        }

        async function startCamera() {
            try {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                videoPreview.srcObject = stream;
                videoPreview.classList.remove('hidden');
                captureButton.classList.remove('hidden');
                capturedImage.classList.add('hidden');
                controlsAfterCapture.classList.add('hidden');
                resultArea.textContent = i18n[currentTargetLanguage].resultPlaceholder; // Use textContent for placeholder
                tellMeMoreButton.classList.add('hidden');
                moreInfoArea.classList.add('hidden');
                moreInfoArea.textContent = i18n[currentTargetLanguage].moreInfoPlaceholder; // Use textContent for placeholder
            } catch (err) {
                console.error("Error accessing camera: ", err);
                resultArea.textContent = i18n[currentTargetLanguage].alert_cameraError + err.message;
            }
        }

        saveSettingsButton.addEventListener('click', () => {
            const apiKey = apiKeyInput.value.trim();
            if (!apiKey) {
                alert(i18n[currentTargetLanguage].alert_apiKeyRequired);
                return;
            }
            currentApiKey = apiKey;
            localStorage.setItem('apiKey', apiKey);
            
            currentTargetLanguage = targetLanguageSelect.value;
            localStorage.setItem('targetLanguage', currentTargetLanguage);
            updateUIStrings(currentTargetLanguage); 

            settingsView.classList.add('hidden');
            appView.classList.remove('hidden');
            startCamera();
        });

        targetLanguageSelect.addEventListener('change', (event) => {
            updateUIStrings(event.target.value);
        });

        captureButton.addEventListener('click', () => {
            canvas.width = videoPreview.videoWidth;
            canvas.height = videoPreview.videoHeight;
            const context = canvas.getContext('2d');
            context.drawImage(videoPreview, 0, 0, canvas.width, canvas.height);
            
            const imageDataUrl = canvas.toDataURL('image/jpeg', 0.9);
            capturedImage.src = imageDataUrl;
            capturedImage.classList.remove('hidden');
            
            videoPreview.classList.add('hidden');
            captureButton.classList.add('hidden');
            controlsAfterCapture.classList.remove('hidden');
            promptHelper.textContent = i18n[currentTargetLanguage].promptHelperText;
            resultArea.textContent = i18n[currentTargetLanguage].resultPlaceholder; // Reset result area using textContent
            tellMeMoreButton.classList.add('hidden'); // Hide tell me more button
            moreInfoArea.classList.add('hidden'); // Hide more info area
            moreInfoArea.textContent = i18n[currentTargetLanguage].moreInfoPlaceholder; // Reset more info area using textContent


            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        });

        recaptureButton.addEventListener('click', () => {
            startCamera(); 
            resultArea.textContent = i18n[currentTargetLanguage].resultPlaceholder;
            tellMeMoreButton.classList.add('hidden');
            moreInfoArea.classList.add('hidden');
            moreInfoArea.textContent = i18n[currentTargetLanguage].moreInfoPlaceholder;
        });

        async function callGeminiAPI(promptText, base64ImageData, resultDisplayElement, loadingElement, responsePrefix, placeholderText) {
            if (!base64ImageData) { 
                alert(i18n[currentTargetLanguage].alert_noImage);
                return;
            }
            if (!currentApiKey) {
                alert(i18n[currentTargetLanguage].alert_apiKeyRequired);
                return;
            }

            loadingElement.classList.remove('hidden');
            resultDisplayElement.innerHTML = ''; // Use innerHTML
            resultDisplayElement.classList.remove('hidden');


            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${currentApiKey}`;
            
            const requestBody = {
                contents: [{
                    parts: [
                        { text: promptText },
                        {
                            inline_data: {
                                mime_type: "image/jpeg",
                                data: base64ImageData
                            }
                        }
                    ]
                }],
                 generationConfig: {
                   temperature: 0.3, 
                   maxOutputTokens: 4096, // <-- Already 4096 from previous step
                 }
            };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('API Error Response:', errorData);
                    throw new Error(`HTTP error! status: ${response.status} - ${errorData.error?.message || 'Unknown error'}`);
                }

                const data = await response.json();
                
                if (data.candidates && data.candidates.length > 0 && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts.length > 0) {
                    const description = data.candidates[0].content.parts[0].text;
                    // Use marked.parse to convert Markdown to HTML
                    resultDisplayElement.innerHTML = responsePrefix + marked.parse(description);
                    if (resultDisplayElement === resultArea) { // Only show "Tell me more" after initial description
                        tellMeMoreButton.classList.remove('hidden');
                    }
                } else if (data.promptFeedback && data.promptFeedback.blockReason) {
                    let blockMessage = `${i18n[currentTargetLanguage].alert_apiError} Blocked by API. Reason: ${data.promptFeedback.blockReason}`;
                     if (data.promptFeedback.safetyRatings) {
                        blockMessage += `\nDetails: ${data.promptFeedback.safetyRatings.map(r => `${r.category} was ${r.probability}`).join(', ')}`;
                    }
                    resultDisplayElement.textContent = blockMessage; // Use textContent for error messages
                    if (resultDisplayElement === resultArea) tellMeMoreButton.classList.add('hidden');
                }
                else {
                    console.warn("Unexpected API response structure:", data);
                    resultDisplayElement.textContent = i18n[currentTargetLanguage].alert_apiError + 'Could not parse description from API response. Check console for details.'; // Use textContent for error messages
                    if (resultDisplayElement === resultArea) tellMeMoreButton.classList.add('hidden');
                }

            } catch (error) {
                console.error("Error calling Gemini API:", error);
                resultDisplayElement.textContent = i18n[currentTargetLanguage].alert_apiError + error.message; // Use textContent for error messages
                if (resultDisplayElement === resultArea) tellMeMoreButton.classList.add('hidden');
            } finally {
                loadingElement.classList.add('hidden');
                // If content is empty after processing, set placeholder text
                if (resultDisplayElement.innerHTML.trim() === '' || resultDisplayElement.textContent.trim() === '') {
                     resultDisplayElement.textContent = placeholderText; // Ensure placeholder is plain text
                }
            }
        }


        describeButton.addEventListener('click', async () => {
            const base64ImageData = capturedImage.src.split(',')[1];
            tellMeMoreButton.classList.add('hidden'); // Hide before new request
            moreInfoArea.classList.add('hidden');     // Hide more info area
            moreInfoArea.textContent = i18n[currentTargetLanguage].moreInfoPlaceholder; // Reset more info area with plain text
            
            await callGeminiAPI(
                i18n[currentTargetLanguage].apiPrompt,
                base64ImageData,
                resultArea,
                loadingIndicator,
                i18n[currentTargetLanguage].apiResponsePrefix,
                i18n[currentTargetLanguage].resultPlaceholder
            );
        });

        tellMeMoreButton.addEventListener('click', async () => {
            const base64ImageData = capturedImage.src.split(',')[1];
            moreInfoArea.classList.remove('hidden'); // Ensure more info area is visible for loading indicator
            moreInfoArea.innerHTML = i18n[currentTargetLanguage].moreInfoPlaceholder; // Reset with plain text placeholder

            await callGeminiAPI(
                i18n[currentTargetLanguage].apiPromptMoreInfo,
                base64ImageData,
                moreInfoArea,
                moreInfoLoadingIndicator, // Use dedicated loader for this
                i18n[currentTargetLanguage].moreInfoPrefix,
                i18n[currentTargetLanguage].moreInfoPlaceholder
            );
        });


        backToSettingsButton.addEventListener('click', () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            appView.classList.add('hidden');
            settingsView.classList.remove('hidden');
            capturedImage.src = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII="; 
            capturedImage.classList.add('hidden');
            resultArea.textContent = i18n[currentTargetLanguage].resultPlaceholder; 
            tellMeMoreButton.classList.add('hidden');
            moreInfoArea.classList.add('hidden');
            moreInfoArea.textContent = i18n[currentTargetLanguage].moreInfoPlaceholder;
            controlsAfterCapture.classList.add('hidden');
            videoPreview.classList.remove('hidden'); 
            captureButton.classList.remove('hidden'); 
        });

        // Initial load
        loadSettings();
        // Always show settings first unless API key is already set and you want to auto-skip settings with a saved key
        if (currentApiKey && false) { // Set to true if you want to auto-skip settings with a saved key
             settingsView.classList.add('hidden');
             appView.classList.remove('hidden');
             startCamera();
        } else {
            settingsView.classList.remove('hidden');
            appView.classList.add('hidden');
        }

    </script>
</body>
</html>
