<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI 圖像辨識翻譯</title>
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --background-color: #f8f9fa;
            --text-color: #212529;
            --card-bg: #ffffff;
            --border-radius: 8px;
            --box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 15px;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
        }
        .container {
            width: 100%;
            max-width: 500px;
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 20px;
        }
        h1 {
            color: var(--primary-color);
            text-align: center;
            font-size: 1.8em;
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        input[type="text"],
        input[type="password"],
        select {
            width: calc(100% - 22px);
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: var(--border-radius);
            font-size: 1em;
        }
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 1em;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color 0.3s ease;
            width: 100%;
            box-sizing: border-box;
        }
        button:hover {
            background-color: #0056b3;
        }
        button.secondary {
            background-color: var(--secondary-color);
        }
        button.secondary:hover {
            background-color: #545b62;
        }
        #cameraView, #appView {
            width: 100%;
        }
        #videoPreview {
            width: 100%;
            max-width: 480px;
            height: auto;
            border: 1px solid #ccc;
            background-color: #000;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
        }
        #capturedImage {
            max-width: 100%;
            height: auto;
            border: 1px solid #ccc;
            border-radius: var(--border-radius);
            margin-top: 15px;
            display: none;
        }
        #resultArea {
            margin-top: 20px;
            padding: 15px;
            background-color: #e9ecef;
            border-radius: var(--border-radius);
            min-height: 50px;
            white-space: pre-wrap; /* Preserve line breaks */
            word-wrap: break-word;
        }
        .hidden {
            display: none !important;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .button-group button {
            flex: 1;
        }
    </style>
</head>
<body>
    <div id="settingsView" class="container">
        <h1>設定</h1>
        <div>
            <label for="apiKey" data-i18n="apiKeyLabel">API 金鑰:</label>
            <input type="password" id="apiKey" placeholder="請輸入您的 Gemini API 金鑰">
        </div>
        <div>
            <label for="targetLanguage" data-i18n="languageLabel">目標語言:</label>
            <select id="targetLanguage">
                <option value="zh-TW">繁體中文 (台灣)</option>
                <option value="en">English</option>
                <option value="ja">日本語</option>
                <option value="ko">한국어</option>
            </select>
        </div>
        <button id="saveSettings" data-i18n="saveSettingsButton">儲存設定並開始</button>
    </div>

    <div id="appView" class="container hidden">
        <h1 data-i18n="appTitle">圖像辨識</h1>
        <div id="cameraView">
            <video id="videoPreview" autoplay playsinline></video>
            <button id="captureButton" data-i18n="captureButton">拍攝</button>
            <canvas id="canvas" class="hidden"></canvas>
        </div>
        
        <img id="capturedImage" alt="Captured Image">
        
        <div id="controlsAfterCapture" class="hidden">
            <p id="promptHelper" data-i18n="promptHelperText">已拍攝照片。點擊下方按鈕進行描述。</p>
            <div class="button-group">
                <button id="describeButton" data-i18n="describeButton">描述圖片</button>
                <button id="recaptureButton" class="secondary" data-i18n="recaptureButton">重新拍攝</button>
            </div>
        </div>

        <div id="loadingIndicator" class="loader hidden"></div>
        <div id="resultArea" data-i18n-placeholder="resultPlaceholder">辨識結果將顯示於此</div>
        <button id="backToSettings" class="secondary" data-i18n="backToSettingsButton" style="margin-top: 20px;">返回設定</button>
    </div>

    <script>
        const settingsView = document.getElementById('settingsView');
        const appView = document.getElementById('appView');
        const apiKeyInput = document.getElementById('apiKey');
        const targetLanguageSelect = document.getElementById('targetLanguage');
        const saveSettingsButton = document.getElementById('saveSettings');
        
        const videoPreview = document.getElementById('videoPreview');
        const canvas = document.getElementById('canvas');
        const captureButton = document.getElementById('captureButton');
        const capturedImage = document.getElementById('capturedImage');
        const describeButton = document.getElementById('describeButton');
        const recaptureButton = document.getElementById('recaptureButton');
        const controlsAfterCapture = document.getElementById('controlsAfterCapture');
        
        const loadingIndicator = document.getElementById('loadingIndicator');
        const resultArea = document.getElementById('resultArea');
        const backToSettingsButton = document.getElementById('backToSettings');
        const promptHelper = document.getElementById('promptHelper');

        let stream;
        let currentApiKey = '';
        let currentTargetLanguage = 'zh-TW';

        const i18n = {
            'zh-TW': {
                apiKeyLabel: 'API 金鑰:',
                languageLabel: '目標語言:',
                saveSettingsButton: '儲存設定並開始',
                appTitle: 'AI 圖像辨識',
                captureButton: '拍攝',
                describeButton: '描述圖片',
                recaptureButton: '重新拍攝',
                resultPlaceholder: '辨識結果將顯示於此',
                backToSettingsButton: '返回設定',
                alert_apiKeyRequired: '請輸入 API 金鑰。',
                alert_cameraError: '無法啟動相機: ',
                alert_apiError: 'API 請求失敗: ',
                alert_noImage: '請先拍攝一張照片。',
                promptHelperText: '已拍攝照片。點擊下方按鈕進行描述。',
                apiPrompt: '這是一張圖片。請使用台灣用語的繁體中文，詳細描述圖中的主要物品、場景、可能的用途或情境。如果有多個物品，請都描述到。',
                apiResponsePrefix: 'AI 描述 (台灣用語繁中):\n'
            },
            'en': {
                apiKeyLabel: 'API Key:',
                languageLabel: 'Target Language:',
                saveSettingsButton: 'Save Settings & Start',
                appTitle: 'AI Image Recognition',
                captureButton: 'Capture',
                describeButton: 'Describe Image',
                recaptureButton: 'Recapture',
                resultPlaceholder: 'Recognition result will appear here',
                backToSettingsButton: 'Back to Settings',
                alert_apiKeyRequired: 'Please enter API Key.',
                alert_cameraError: 'Could not start camera: ',
                alert_apiError: 'API request failed: ',
                alert_noImage: 'Please capture an image first.',
                promptHelperText: 'Photo captured. Click button below to describe.',
                apiPrompt: 'This is an image. Please describe in detail the main objects, scene, possible uses or context in the image. If there are multiple items, please describe them all.',
                apiResponsePrefix: 'AI Description (English):\n'
            },
            'ja': {
                apiKeyLabel: 'APIキー:',
                languageLabel: 'ターゲット言語:',
                saveSettingsButton: '設定を保存して開始',
                appTitle: 'AI画像認識',
                captureButton: '撮影',
                describeButton: '画像を説明',
                recaptureButton: '再撮影',
                resultPlaceholder: '認識結果はここに表示されます',
                backToSettingsButton: '設定に戻る',
                alert_apiKeyRequired: 'APIキーを入力してください。',
                alert_cameraError: 'カメラを起動できませんでした: ',
                alert_apiError: 'APIリクエストに失敗しました: ',
                alert_noImage: 'まず画像を撮影してください。',
                promptHelperText: '写真が撮影されました。下のボタンをクリックして説明してください。',
                apiPrompt: 'これは画像です。画像内の主な物体、シーン、考えられる用途や文脈を詳細に説明してください。複数のアイテムがある場合は、すべて説明してください。',
                apiResponsePrefix: 'AIによる説明 (日本語):\n'
            },
            'ko': {
                apiKeyLabel: 'API 키:',
                languageLabel: '대상 언어:',
                saveSettingsButton: '설정 저장 및 시작',
                appTitle: 'AI 이미지 인식',
                captureButton: '촬영',
                describeButton: '이미지 설명',
                recaptureButton: '다시 촬영',
                resultPlaceholder: '인식 결과가 여기에 표시됩니다',
                backToSettingsButton: '설정으로 돌아가기',
                alert_apiKeyRequired: 'API 키를 입력하십시오.',
                alert_cameraError: '카메라를 시작할 수 없습니다: ',
                alert_apiError: 'API 요청 실패: ',
                alert_noImage: '먼저 이미지를 촬영하십시오.',
                promptHelperText: '사진이 촬영되었습니다. 아래 버튼을 클릭하여 설명하십시오.',
                apiPrompt: '이것은 이미지입니다. 이미지의 주요 개체, 장면, 가능한 용도 또는 맥락을 자세히 설명하십시오. 여러 항목이 있는 경우 모두 설명하십시오.',
                apiResponsePrefix: 'AI 설명 (한국어):\n'
            }
        };

        function updateUIStrings(lang) {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (i18n[lang] && i18n[lang][key]) {
                    el.textContent = i18n[lang][key];
                }
            });
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (i18n[lang] && i18n[lang][key]) {
                    if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                        el.placeholder = i18n[lang][key];
                    } else {
                         // For resultArea, set its initial text if empty
                        if (el.id === 'resultArea' && (el.textContent.trim() === '' || el.textContent.startsWith('辨識結果將顯示於此') || el.textContent.startsWith('Recognition result will appear here'))) {
                           el.textContent = i18n[lang][key];
                        }
                    }
                }
            });
            currentTargetLanguage = lang;
            localStorage.setItem('targetLanguage', lang);
            // Update prompt helper text if it's visible
            if (!controlsAfterCapture.classList.contains('hidden')) {
                promptHelper.textContent = i18n[currentTargetLanguage].promptHelperText;
            }
        }
        
        function loadSettings() {
            const savedApiKey = localStorage.getItem('apiKey');
            const savedLanguage = localStorage.getItem('targetLanguage');

            if (savedApiKey) {
                apiKeyInput.value = savedApiKey;
                currentApiKey = savedApiKey;
            }
            if (savedLanguage) {
                targetLanguageSelect.value = savedLanguage;
                currentTargetLanguage = savedLanguage;
            } else {
                targetLanguageSelect.value = 'zh-TW'; // Default
                currentTargetLanguage = 'zh-TW';
            }
            updateUIStrings(currentTargetLanguage);
        }

        async function startCamera() {
            try {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                videoPreview.srcObject = stream;
                videoPreview.classList.remove('hidden');
                captureButton.classList.remove('hidden');
                capturedImage.classList.add('hidden');
                controlsAfterCapture.classList.add('hidden');
                resultArea.textContent = i18n[currentTargetLanguage].resultPlaceholder;
            } catch (err) {
                console.error("Error accessing camera: ", err);
                resultArea.textContent = i18n[currentTargetLanguage].alert_cameraError + err.message;
            }
        }

        saveSettingsButton.addEventListener('click', () => {
            const apiKey = apiKeyInput.value.trim();
            if (!apiKey) {
                alert(i18n[currentTargetLanguage].alert_apiKeyRequired);
                return;
            }
            currentApiKey = apiKey;
            localStorage.setItem('apiKey', apiKey);
            
            currentTargetLanguage = targetLanguageSelect.value;
            localStorage.setItem('targetLanguage', currentTargetLanguage);
            updateUIStrings(currentTargetLanguage); // Update UI before switching view

            settingsView.classList.add('hidden');
            appView.classList.remove('hidden');
            startCamera();
        });

        targetLanguageSelect.addEventListener('change', (event) => {
            updateUIStrings(event.target.value);
        });

        captureButton.addEventListener('click', () => {
            canvas.width = videoPreview.videoWidth;
            canvas.height = videoPreview.videoHeight;
            const context = canvas.getContext('2d');
            context.drawImage(videoPreview, 0, 0, canvas.width, canvas.height);
            
            const imageDataUrl = canvas.toDataURL('image/jpeg');
            capturedImage.src = imageDataUrl;
            capturedImage.classList.remove('hidden');
            
            videoPreview.classList.add('hidden');
            captureButton.classList.add('hidden');
            controlsAfterCapture.classList.remove('hidden');
            promptHelper.textContent = i18n[currentTargetLanguage].promptHelperText;

            // Stop camera stream after capture
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        });

        recaptureButton.addEventListener('click', () => {
            startCamera(); // This will hide capturedImage and show video again
        });

        describeButton.addEventListener('click', async () => {
            if (!capturedImage.src || capturedImage.src === window.location.href) { // Check if src is set and not just the base URL
                alert(i18n[currentTargetLanguage].alert_noImage);
                return;
            }
            if (!currentApiKey) {
                alert(i18n[currentTargetLanguage].alert_apiKeyRequired);
                return;
            }

            loadingIndicator.classList.remove('hidden');
            resultArea.textContent = ''; // Clear previous results

            // Extract base64 data from dataURL
            const base64ImageData = capturedImage.src.split(',')[1];
            
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${currentApiKey}`;
            
            const requestBody = {
                contents: [{
                    parts: [
                        { text: i18n[currentTargetLanguage].apiPrompt },
                        {
                            inline_data: {
                                mime_type: "image/jpeg",
                                data: base64ImageData
                            }
                        }
                    ]
                }],
                // Optional: Add generationConfig if needed
                // generationConfig: {
                //   temperature: 0.4,
                //   topK: 32,
                //   topP: 1,
                //   maxOutputTokens: 4096,
                //   stopSequences: []
                // }
            };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('API Error Response:', errorData);
                    throw new Error(`HTTP error! status: ${response.status} - ${errorData.error?.message || 'Unknown error'}`);
                }

                const data = await response.json();
                
                if (data.candidates && data.candidates.length > 0 && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts.length > 0) {
                    const description = data.candidates[0].content.parts[0].text;
                    resultArea.textContent = i18n[currentTargetLanguage].apiResponsePrefix + description;
                } else if (data.promptFeedback && data.promptFeedback.blockReason) {
                    resultArea.textContent = `${i18n[currentTargetLanguage].alert_apiError} Blocked by API. Reason: ${data.promptFeedback.blockReason}`;
                     if (data.promptFeedback.safetyRatings) {
                        resultArea.textContent += `\nSafety Ratings: ${JSON.stringify(data.promptFeedback.safetyRatings)}`;
                    }
                }
                else {
                    console.warn("Unexpected API response structure:", data);
                    resultArea.textContent = i18n[currentTargetLanguage].alert_apiError + 'Could not parse description from API response.';
                }

            } catch (error) {
                console.error("Error calling Gemini API:", error);
                resultArea.textContent = i18n[currentTargetLanguage].alert_apiError + error.message;
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        });

        backToSettingsButton.addEventListener('click', () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            appView.classList.add('hidden');
            settingsView.classList.remove('hidden');
            // Clear results and image when going back
            capturedImage.src = "";
            capturedImage.classList.add('hidden');
            resultArea.textContent = i18n[currentTargetLanguage].resultPlaceholder;
            controlsAfterCapture.classList.add('hidden');
            videoPreview.classList.remove('hidden');
            captureButton.classList.remove('hidden');
        });

        // Initial load
        loadSettings();
        // Check if settings are already sufficient to go to app view
        if (currentApiKey) {
             // Optionally auto-switch if API key is present, or require user to click "Save & Start"
             // For now, let's require the click to confirm language and start camera.
             // settingsView.classList.add('hidden');
             // appView.classList.remove('hidden');
             // startCamera();
        } else {
            settingsView.classList.remove('hidden');
            appView.classList.add('hidden');
        }

    </script>
</body>
</html>